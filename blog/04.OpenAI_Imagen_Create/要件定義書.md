# Universal AI画像生成システム 要件定義書

## 1. プロジェクト概要

### 1.1 目的
OpenAI GPT-image-1 APIを中心とした画像生成システムを構築し、独自のプロンプト強化システムによる一貫性のある高品質画像生成を実現する。汎用的なライブラリ構成により他のAI画像生成サービスとの統合も可能とする。

### 1.2 背景
- テーマに基づく一貫性のある画像生成のニーズ
- 独自キャラクター設定による世界観の統一
- コスト管理とファイル管理の自動化
- 他システムへの組み込み可能性を考慮した設計

## 2. 機能要件

### 2.1 画像生成機能
- OpenAI GPT-image-1 APIを使用した画像生成
- 簡単なテーマから詳細プロンプトへの自動変換
- YAMLテンプレートベースのプロンプト強化
- 固定キャラクター設定（ボス猫、インターン猫、ロボ助手）
- シーンバリエーションのランダム選択
- 画像サイズ・品質の指定
- 粘土フィギュア風の一貫した質感表現

### 2.2 ファイル管理機能
- 日付別フォルダ構造の自動作成（YYYY-MM-DD）
- テーマベースのファイル名自動生成
- ファイル形式のカスタマイズ対応
- 重複ファイル名の自動回避
- ディレクトリ情報の取得・管理
- 古いファイルの自動削除機能

### 2.3 コスト追跡・制御機能
- API使用量のリアルタイム追跡
- 日次・月次予算制限の設定
- 予算超過時の自動停止機能
- 使用履歴の詳細記録
- コストサマリーの自動生成
- データエクスポート機能
- 古いコストデータの自動削除

### 2.4 プロンプト強化システム
- YAMLテンプレートの解析・処理
- テーマ別シーンバリエーションの管理
- AI可変ブロックの自動埋め込み
- プロンプト構造の最適化（flatten処理）
- カスタムテーマ・バリエーションの追加機能
- テンプレート設定の動的読み込み

### 2.5 認証・セキュリティ機能
- OpenAI API認証
- APIキーの環境変数管理
- 設定ファイルのセキュア読み込み

## 3. 非機能要件

### 3.1 性能要件
- 画像生成時間: 30秒以内/枚
- プロンプト強化処理: 1秒以内
- ファイル保存時間: 3秒以内
- システム初期化時間: 5秒以内

### 3.2 可用性要件
- 稼働率: 99%以上
- API障害時の適切なエラーハンドリング
- テンプレートファイル読み込み失敗時のフォールバック
- 予算制限機能の確実な動作

### 3.3 セキュリティ要件
- APIキーの環境変数による安全な管理
- 通信の暗号化（HTTPS）
- 操作ログの詳細記録
- 秘密情報のファイルコミット防止

### 3.4 運用要件
- 構造化ログの出力
- 使用状況の詳細モニタリング
- YAMLテンプレートによる設定変更の容易さ
- システム状態の監視機能
- コストデータの可視化

## 4. 制約事項

### 4.1 技術制約
- OpenAI APIの利用制限に準拠
- API rate limitの遵守
- 対応画像フォーマット: PNG
- プロンプト長制限の考慮

### 4.2 コスト制約
- 日次・月次予算上限の設定必須
- 予算超過時の自動停止機能
- 1回あたりのコスト: $0.04（標準）

### 4.3 環境制約
- インターネット接続必須
- Node.js/TypeScript実行環境
- 十分なストレージ容量（画像保存用）

## 5. 入出力仕様

### 5.1 入力
- 簡単なテーマ（例: "会議", "AI情報", "プレゼン"）
- YAMLテンプレートファイル（prompt_guide.md）
- 環境変数設定（APIキー、予算制限等）
- オプション画像パラメータ（サイズ、品質）

### 5.2 出力
- 粘土フィギュア風の高品質画像ファイル（PNG）
- 詳細なコストサマリー
- 強化されたプロンプト情報
- 構造化実行ログ
- システム状態情報

## 6. システム構成

### 6.1 汎用ライブラリ（src/lib/）
- UniversalPromptEnhancer: プロンプト強化エンジン
- UniversalFileManager: ファイル管理システム
- UniversalCostTracker: コスト追跡システム

### 6.2 テンプレート管理（src/templates/）
- scene-variations.ts: シーンバリエーション定義
- カスタムテーマ追加機能

### 6.3 統合レイヤー（src/integrations/）
- OpenAIImageGenerationSystem: OpenAI統合システム
- 他API統合用の拡張可能な構造

### 6.4 従来モジュール（src/modules/）
- openai-api.ts: OpenAI API クライアント
- logger.ts: ログ管理

### 6.5 外部連携
- OpenAI GPT-image-1 API
- ローカルファイルシステム
- 環境変数システム

## 7. エラーハンドリング

### 7.1 想定エラー
- OpenAI API接続エラー
- APIキー認証エラー
- 予算制限超過エラー
- テンプレートファイル読み込みエラー
- ディスク容量不足
- ネットワークエラー
- プロンプト生成エラー

### 7.2 エラー対応
- 詳細なエラーメッセージ表示
- グレースフルデグラデーション（テンプレート読み込み失敗時のフォールバック）
- 構造化ログによるエラー追跡
- 予算制限による自動停止

## 8. 今後の拡張性

### 8.1 他システム統合
- Stable Diffusion API統合
- Midjourney API統合
- Google Imagen API統合
- 複数API切り替え機能

### 8.2 機能拡張
- カスタムキャラクター設定機能
- 動的テーマ生成
- 画像後処理・編集機能
- バッチ生成機能

### 8.3 ユーザーインターフェース
- Web UI の提供
- REST API化
- CLI改善

### 8.4 データ管理
- クラウドストレージ対応
- データベース統合
- 生成履歴管理
- 画像メタデータ管理